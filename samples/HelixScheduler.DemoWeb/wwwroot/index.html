<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HelixScheduler Demo</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="bg">
    <div class="grain"></div>
    <div class="orb orb-a"></div>
    <div class="orb orb-b"></div>
  </div>
  <header class="header">
    <div class="title-block">
      <div class="eyebrow">HelixScheduler</div>
      <h1>Demo Availability Explorer</h1>
      <p class="subtitle">Explorer mode: inspect availability for specific resources (UTC).</p>
    </div>
    <div class="actions">
      <nav class="nav">
        <a class="nav-link active" href="/" data-tooltip="Explorer: inspect availability for selected resources (UTC).">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 20 20" role="img" focusable="false">
              <path d="M4 6h12M6 4v4M14 4v4M5 9h10a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6a1 1 0 011-1z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </span>
          Availability Explorer
        </a>
        <a class="nav-link" href="/search" data-tooltip="Search: build queries by type + properties and compute availability (UTC).">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" role="img" focusable="false">
              <circle cx="11" cy="11" r="6" fill="none" stroke="currentColor" stroke-width="1.8"></circle>
              <path d="M16.5 16.5L21 21" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"></path>
            </svg>
          </span>
          Search Availability
        </a>
      </nav>
    </div>
  </header>

  <div id="apiStatus" class="status-bar waiting">
    <span class="spinner"></span>
    <span id="apiStatusMessage">Waiting for API...</span>
    <button id="apiRetry" class="btn ghost">Retry now</button>
  </div>

  <main class="layout">
    <aside class="panel">
      <div class="panel-section">
        <div class="week-card">
          <div class="week-title">
            <span class="week-icon" aria-hidden="true">
              <svg viewBox="0 0 20 20" role="img" focusable="false">
                <path d="M6 3v2M14 3v2M4 7h12M5 5h10a1 1 0 011 1v10a1 1 0 01-1 1H5a1 1 0 01-1-1V6a1 1 0 011-1z" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
              </svg>
            </span>
            <div>
              <div class="week-heading">Week</div>
              <div id="weekLabel" class="week-range">Loading...</div>
            </div>
          </div>
          <div class="week-controls">
            <button id="prevWeek" class="btn">Prev</button>
            <button id="nextWeek" class="btn">Next</button>
          </div>
        </div>
      </div>

      <div class="panel-section">
        <details class="accordion" open>
          <summary>
            <span class="summary-title">
              Resources
              <span class="info-icon" data-tooltip="Explorer lists schedulable resources only. Use Search to select non-schedulable resources (e.g., Site/Floor).">i</span>
            </span>
            <span class="summary-icon" aria-hidden="true">
              <svg viewBox="0 0 20 20" role="img" focusable="false">
                <path d="M5 7l5 6 5-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              </svg>
            </span>
          </summary>
          <div class="accordion-body">
            <div id="resourceList" class="resource-list">Loading...</div>
          </div>
        </details>
      </div>

      <div class="panel-section">
        <details class="accordion">
          <summary>
            <span class="summary-title">
              Properties
              <span class="info-icon" data-tooltip="Filter resources by property values (type-aware).">i</span>
            </span>
            <span class="summary-icon" aria-hidden="true">
              <svg viewBox="0 0 20 20" role="img" focusable="false">
                <path d="M5 7l5 6 5-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              </svg>
            </span>
          </summary>
          <div class="accordion-body">
            <p class="microcopy">Properties are defined per resource type.</p>
            <p class="microcopy">
              <span class="info-icon" data-tooltip="Explorer lists schedulable resources only, so properties for non-schedulable types (e.g., Site) are hidden. Use Search to filter those.">!</span>
              Properties for non-schedulable resource types are hidden here.
            </p>
            <div id="propertyGroups" class="property-groups">Loading...</div>
            <div id="propertyChips" class="chip-list">No property filter.</div>
            <div id="propertyFilterNotice" class="notice warning" style="display: none;"></div>
            <label class="toggle">
              <input type="checkbox" id="toggleDescendants" />
              <span>
                Include property descendants
                <span class="info-icon" data-tooltip="When enabled, child properties in the hierarchy are included in the filter.">i</span>
              </span>
            </label>
          </div>
        </details>
      </div>

      <div class="panel-section">
        <details class="accordion">
          <summary>
            <span class="summary-title">
              Options
              <span class="info-icon" data-tooltip="Explain, ancestor filters, slot duration, and ID visibility.">i</span>
            </span>
            <span class="summary-icon" aria-hidden="true">
              <svg viewBox="0 0 20 20" role="img" focusable="false">
                <path d="M5 7l5 6 5-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              </svg>
            </span>
          </summary>
          <div class="accordion-body">
            <label class="toggle">
              <input type="checkbox" id="toggleExplain" checked />
              <span>Explain availability</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="toggleShowIds" />
              <span>
                Show IDs
                <span class="info-icon" data-tooltip="Show internal IDs in resource and property labels.">i</span>
              </span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="toggleAncestors" />
              <span>
                Include resource ancestors
                <span class="info-icon" data-tooltip="When enabled, availability must also satisfy parent resources in the hierarchy.">i</span>
              </span>
            </label>
            <div id="ancestorTypesWrap" class="property-group">
              <div class="group-title">
                Ancestor relation types
                <span class="info-icon" data-tooltip="Optional filters for ancestor link types. Leave all unchecked to include every relation.">i</span>
              </div>
              <p class="microcopy">Ancestor filters apply only when resource ancestors are included.</p>
              <div class="chip-list">
                <label class="toggle">
                  <input type="checkbox" id="ancestorTypesAll" checked />
                  <span>All relation types</span>
                </label>
                <div id="ancestorTypesSpecific" class="relation-specific" style="display: none;">
                  <label class="toggle">
                    <input type="checkbox" name="ancestorRelationType" value="Contains" />
                    <span>Contains</span>
                  </label>
                  <label class="toggle">
                    <input type="checkbox" name="ancestorRelationType" value="WorksIn" />
                    <span>WorksIn</span>
                  </label>
                </div>
              </div>
              <div id="ancestorFiltersWrap">
                <div class="group-title">Ancestor filters</div>
                <p class="microcopy">Filter ancestors by type + properties. Defaults to OR and any ancestor.</p>
                <div class="input-row">
                  <span>
                    Ancestor type
                    <span class="info-icon" data-tooltip="Only ancestors of this resource type are evaluated.">i</span>
                  </span>
                  <select id="ancestorFilterType" class="property-select"></select>
                </div>
                <div class="input-row">
                  <span>
                    Property definition
                    <span class="info-icon" data-tooltip="Property group allowed for the selected type (e.g., Location).">i</span>
                  </span>
                  <select id="ancestorFilterDefinition" class="property-select"></select>
                </div>
                <div class="input-row">
                  <span>
                    Property value
                    <span class="info-icon" data-tooltip="Specific property value to match (e.g., Milano).">i</span>
                  </span>
                  <select id="ancestorFilterProperty" class="property-select"></select>
                </div>
                <label class="toggle">
                  <input type="checkbox" id="ancestorFilterIncludeDescendants" />
                  <span>
                    Include property descendants
                    <span class="info-icon" data-tooltip="Include child properties under the selected value.">i</span>
                  </span>
                </label>
                <div class="input-row">
                  <span>
                    Match mode
                    <span class="info-icon" data-tooltip="OR = any propertyId matches; AND = all propertyIds must match.">i</span>
                  </span>
                  <select id="ancestorFilterMatchMode" class="property-select">
                    <option value="or">or</option>
                    <option value="and">and</option>
                  </select>
                </div>
                <div class="input-row">
                  <span>
                    Scope
                    <span class="info-icon" data-tooltip="anyAncestor, directParent, or nearest ancestor of the specified type.">i</span>
                  </span>
                  <select id="ancestorFilterScope" class="property-select">
                    <option value="anyAncestor">anyAncestor</option>
                    <option value="directParent">directParent</option>
                    <option value="nearestOfType">nearestOfType</option>
                  </select>
                </div>
                <label class="toggle">
                  <input type="checkbox" id="ancestorFilterMatchAll" />
                  <span>
                    Match all ancestors
                    <span class="info-icon" data-tooltip="When enabled, all eligible ancestors must match; otherwise any one match is enough.">i</span>
                  </span>
                </label>
                <div class="input-row">
                  <button id="addAncestorFilter" class="btn small">Add ancestor filter</button>
                  <button id="clearAncestorFilters" class="btn ghost small">Clear</button>
                </div>
                <div id="ancestorFilterChips" class="chip-list">No ancestor filters.</div>
              </div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="toggleSlotDuration" />
              <span>
                Define slot duration
                <span class="info-icon" data-tooltip="When enabled, availability is chunked into consecutive full slots.">i</span>
              </span>
            </label>
            <div id="slotDurationWrap" class="property-group">
              <div class="group-title">Slot duration</div>
              <label class="input-row">
                <span>Slot duration (minutes)</span>
                <input id="slotDurationMinutes" type="number" min="1" max="1440" class="property-select" placeholder="e.g. 30" />
              </label>
              <label class="toggle" id="includeRemainderWrap">
                <input type="checkbox" id="includeRemainderSlot" />
                <span>
                  Include remainder slot
                  <span class="info-icon" data-tooltip="When slot duration is set, include a final partial slot if there is leftover time.">i</span>
                </span>
              </label>
            </div>
          </div>
        </details>
      </div>

      <div class="panel-section">
        <details class="accordion">
          <summary>
            <span class="summary-title">
              Request preview
              <span class="info-icon" data-tooltip="Shows the JSON payload sent to /api/availability/compute.">i</span>
            </span>
            <span class="summary-icon" aria-hidden="true">
              <svg viewBox="0 0 20 20" role="img" focusable="false">
                <path d="M5 7l5 6 5-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              </svg>
            </span>
          </summary>
          <div class="accordion-body">
            <div class="payload-actions">
              <button id="copyPayload" class="btn ghost small">Copy payload</button>
              <button class="btn ghost small toggle-payload" data-target="payloadPreview">Expand payload</button>
            </div>
            <pre id="payloadPreview" class="payload-preview">{}</pre>
          </div>
        </details>
      </div>

      <div class="panel-section">
        <button id="refresh" class="btn primary primary-cta full-width">Refresh availability</button>
      </div>

    </aside>

    <section class="panel wide">
      <details class="accordion" open>
        <summary>
          <span class="summary-title summary-title-primary">
            Availability Calendar (UTC)
            <span class="info-icon" data-tooltip="Computed availability slots for the selected range.">i</span>
          </span>
          <div class="legend">
            <span class="pill">Slots</span>
            <span class="pill light">Busy</span>
            <span id="computeStatus" class="pill badge">Waiting</span>
          </div>
          <span class="summary-icon" aria-hidden="true">
            <svg viewBox="0 0 20 20" role="img" focusable="false">
              <path d="M5 7l5 6 5-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </span>
        </summary>
        <div class="accordion-body">
          <p class="microcopy">Computed availability from rules after subtracting busy intervals.</p>
          <p class="microcopy">Slots can include contributions from multiple rules.</p>
          <details class="accordion flow-accordion">
            <summary>
              <span class="summary-title">
                How availability is computed
                <span class="info-icon" data-tooltip="Step-by-step flow from rules to final slots.">i</span>
              </span>
              <span class="summary-icon" aria-hidden="true">
                <svg viewBox="0 0 20 20" role="img" focusable="false">
                  <path d="M5 7l5 6 5-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
              </span>
            </summary>
            <div class="accordion-body">
              <div class="flow-note">
                <div>1) Rules generate candidate windows per resource.</div>
                <div>2) Windows are intersected across required resources.</div>
                <div>3) Busy intervals remove or split candidates into final slots.</div>
              </div>
            </div>
          </details>
          <details id="querySummary" class="accordion query-summary query-accordion flow-accordion">
            <summary>
              <span class="summary-title">
                Current availability query
                <span class="info-icon" data-tooltip="Summary of the current selection and filters.">i</span>
              </span>
              <span class="summary-icon" aria-hidden="true">
                <svg viewBox="0 0 20 20" role="img" focusable="false">
                  <path d="M5 7l5 6 5-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
              </span>
            </summary>
            <div class="query-summary-body">Loading query summary...</div>
          </details>
          <div id="emptyState" class="empty-state notice warning" style="display: none;"></div>
          <div id="selectionInfo" class="selection-info">Click a rule or busy interval to highlight related slots.</div>
          <div id="calendar" class="calendar"></div>
        </div>
      </details>

      <details class="accordion">
        <summary>
          <span class="summary-title">
            Busy Calendar (UTC)
            <span class="info-icon" data-tooltip="Busy intervals that remove or split availability.">i</span>
          </span>
          <span class="summary-icon" aria-hidden="true">
            <svg viewBox="0 0 20 20" role="img" focusable="false">
              <path d="M5 7l5 6 5-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </span>
        </summary>
        <div class="accordion-body">
          <p class="microcopy">Busy intervals that remove or split availability.</p>
          <div id="busyCalendar" class="calendar busy"></div>
        </div>
      </details>

      <div class="divider"></div>

      <details class="accordion" open>
        <summary>
          <span class="summary-title">
            Rules
            <span class="info-icon" data-tooltip="Rules that contribute availability windows.">i</span>
          </span>
          <span class="summary-icon" aria-hidden="true">
            <svg viewBox="0 0 20 20" role="img" focusable="false">
              <path d="M5 7l5 6 5-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </span>
        </summary>
        <div class="accordion-body">
          <p class="microcopy">A rule can contribute to many slots; a slot can have multiple contributing rules.</p>
          <div class="hint-pill">
            <span class="hint-icon" aria-hidden="true">
              <svg viewBox="0 0 20 20" role="img" focusable="false">
                <path d="M7 5h6a3 3 0 010 6H9l-3 3v-3H7a3 3 0 010-6z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
              </svg>
            </span>
            Click a rule to highlight related slots.
          </div>
          <div id="rules" class="stacked">Loading...</div>
        </div>
      </details>

      <details class="accordion">
        <summary>
          <span class="summary-title">
            Busy Slots
            <span class="info-icon" data-tooltip="Busy events associated to selected resources.">i</span>
          </span>
          <span class="summary-icon" aria-hidden="true">
            <svg viewBox="0 0 20 20" role="img" focusable="false">
              <path d="M5 7l5 6 5-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </span>
        </summary>
        <div class="accordion-body">
          <div id="busy" class="stacked">Loading...</div>
        </div>
      </details>

      <details class="accordion" open>
        <summary>
          <span class="summary-title">
            Explain
            <span class="info-icon" data-tooltip="Reason codes when availability is empty or partially blocked.">i</span>
          </span>
          <span class="summary-icon" aria-hidden="true">
            <svg viewBox="0 0 20 20" role="img" focusable="false">
              <path d="M5 7l5 6 5-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </span>
        </summary>
        <div class="accordion-body">
          <div id="explain" class="stacked">Explain disabled.</div>
        </div>
      </details>
    </section>
  </main>

  <footer class="footer">
    <div class="footer-card">
      <div class="footer-left">
        <span>HelixScheduler Demo</span>
        <button id="resetDemo" class="btn ghost subtle tiny reset-inline">Reset Demo (dev)</button>
      </div>
      <div class="footer-center"></div>
      <div class="footer-right">(c) <span id="year"></span> HelixScheduler</div>
    </div>
  </footer>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();
  </script>
  <script src="shared.js"></script>
  <script src="app.js"></script>
</body>
</html>
